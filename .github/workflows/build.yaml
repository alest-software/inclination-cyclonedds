name: Build CycloneDDS

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  #GITHUB_UPLOAD_REPO: ${{ vars.UPLOAD_REPO }}
  #GITHUB_UPLOAD_OWNER: ${{ vars.UPLOAD_OWNER }}
  #GITHUB_UPLOAD_PATH: ${{ vars.UPLOAD_PATH }}
  #GITHUB_UPLOAD_NAME: ${{ secrets.UPLOAD_NAME }}
  #GITHUB_UPLOAD_EMAIL: ${{ secrets.UPLOAD_EMAIL }}
  GITHUB_TOKEN: ${{ secrets.TOKEN }}

jobs:
  cyclonedds:
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64]

    runs-on: ubuntu-latest

    steps:
    - name: Clone
      run: |
        git clone --depth 1 https://github.com/eclipse-cyclonedds/cyclonedds.git
        cd cyclonedds

    - name: Set up dependancies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake

    - name: Build
      run: |
        cd cyclonedds
        mkdir build
        cd build
        cmake -DCPACK_PACKAGING_INSTALL_PREFIX=/opt/inclination ..
        cmake --build .
        cpack -G DEB
        find . -name '*.deb' -exec dpkg -c {} \;

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: eclipse-cyclone-dds-${{ matrix.arch }}
        path: cyclonedds/build/*.deb

  cyclonedds-python:
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64]
    runs-on: ubuntu-latest
    needs: cyclonedds
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: eclipse-cyclone-dds-${{ matrix.arch }}
        path: artifacts
    - name: Clone
      run: |
        git clone --depth 1 https://github.com/eclipse-cyclonedds/cyclonedds-python.git
        cd cyclonedds-python
    - name: Set up dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-build python3-wheel gh
        #find artifacts
        #dpkg -c artifacts/eclipse-cyclone-dds_0.11.0_amd64.deb
        sudo apt install -y ./artifacts/*.deb
        #find /opt/inclination
    - name: Build
      run: |
        cd cyclonedds-python
        CYCLONEDDS_HOME=/opt/inclination python3 -m build --sdist --wheel

    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: eclipse-cyclone-dds-python-${{ matrix.arch }}
        path: cyclonedds-python/dist/*
    - name: Deployment
      run: |
        gh auth status
          #- name: Deployment
      #uses: fjogeleit/http-request-action@v1
        #  with:
        #    url: 'https://api.github.com/repos/alest-software/simple/contents/cyclonedds'

